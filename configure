#!/usr/bin/perl

use strict;
use warnings;

use FileHandle;
use Cwd;
#use lib "/Users/sonndinh/Codes/OpenDDS/tools/scripts/modules";
use lib 'C:\Users\Son Dinh\leonardo-drs\with_tao\OpenDDS\tools\scripts\modules';
use command_utils;

# Assuming we are in the ACE_TAO directory which has both ACE and TAO source tree.
# User can specify the path to MPC using the command-line option,
# or set the MPC_ROOT environment variable.

# Command-line options:
# mpc
# verbose
my %opts;

my %hostEnv = ('build' => 'host');
my %targetEnv = ('build' => 'target');

$opts{'host'} = perlOS_to_host() unless $opts{'host'};

my $is_windows = $opts{'host'} eq 'win32';
my ($slash, $exeext) = $is_windows ? ('\\', '.exe') : ('/', '');

my %specific =
  ($is_windows ?
   ('ext' => 'cmd', 'pathsep' => ';', 'refpre' => '%',
    'refpost' => '%', 'comment' => '::') :
   ('ext' => 'sh', 'pathsep' => ':', 'refpre' => '${',
    'refpost' => '}', 'comment' => '#')
  );

sub perlOS_to_host {
  return 'win32' if $^O eq 'MSWin32';
  return 'macos' if $^O eq 'darwin';
  return $^O;
}

sub setSomeEnv {
  my($hashref, $name, $val) = @_;
  $val = Cwd::abs_path($val) if -d $val;
  $val =~ s!/!\\!g if $is_windows;
  $hashref->{$name} = $val;
}

sub setEnv {
  setSomeEnv(\%targetEnv, @_);
}

sub setHostEnv {
  setSomeEnv(\%hostEnv, @_);
}

sub locate_mpc {
  if (defined $opts{'mpc'}) {
    setEnv('MPC_ROOT', $opts{'mpc'});
  }
  elsif ($ENV{'MPC_ROOT'}) {
    setEnv('MPC_ROOT', $ENV{'MPC_ROOT'});
  }
  else {
    die "ERROR: Can't find MPC.  Please pass the path to MPC as a command-line".
        " option or set the MPC_ROOT environment variable, stopped";
  }
  setHostEnv('MPC_ROOT', $targetEnv{'MPC_ROOT'});
}

sub run_command {
  my $command = shift;
  return command_utils::run_command(
    $command,
    script_name => 'configure',
    dry_run => $opts{'dry-run'},
    verbose => $opts{'verbose'},
    @_,
  );
}

sub clone_host_and_target {
  my $source_dir = '.';
  locate_mpc();
  print "cloning build tree\n" if $opts{'verbose'};
  if (run_command(
      ["$targetEnv{'MPC_ROOT'}/clone_build_tree.pl", 'host', 'target'],
      chdir => $source_dir)) {
    die("Failed to clone tree");
  }
}

sub write_host_workspace {
  my %buildEnv = %{shift()};
  my $file = "$buildEnv{'ACE_ROOT'}" . '/host_tools.mwc';
  my $MWC = new FileHandle;
  open $MWC, ">$file" or die "ERROR: Can't write to $file, stopped";
  print $MWC <<'EOT';
workspace {
  $(ACE_ROOT)/ace/ace.mpc
  $(ACE_ROOT)/apps/gperf/src
  $(TAO_ROOT)/TAO_IDL
  $(TAO_ROOT)/tao/tao.mpc
}
EOT
  $MWC->close;
  print "Wrote host_tools.mwc in $buildEnv{'ACE_ROOT'}\n" if $opts{'verbose'};
}

sub mergeToEnv {
  my $buildEnv = shift;
  for my $k (keys %{$buildEnv}) {
    next if $k eq 'build';
    if ($buildEnv->{$k} =~
        /^\Q$specific{'refpre'}\E$k\Q$specific{'refpost'}\E(.*)/) {
      if ($1 ne '') {
        $ENV{$k} .= $1;
        print "ENV: Appending $1 to $k\n" if $opts{'verbose'};
      }
    }
    else {
      $ENV{$k} = $buildEnv->{$k};
      print "ENV: Setting $k to $buildEnv->{$k}\n" if $opts{'verbose'};
    }
  }
}

sub generate_workspace {
  my $buildEnv = shift;
  my %savedEnv = %ENV;
  print "ENV: saving current environment\n" if $opts{'verbose'};
  mergeToEnv($buildEnv);

  # TODO(sonndinh): Make it more general. For now, assuming Windows host.
  my @mwc_common_args = ('-type', 'vs2022');
  my @mwc = ('perl', "$ENV{ACE_ROOT}/bin/mwc.pl");
  print "Running MPC to generate project files\n";
  if (run_command([@mwc, @mwc_common_args, "$buildEnv->{'ACE_ROOT'}/host_tools.mwc"])) {
    die "ERROR: Error from MPC, stopped";
  }

  %ENV = %savedEnv;
  print "ENV: restoring previous environment\n" if $opts{'verbose'};
}

sub configure_build {
  my $buildEnvRef = shift;
  if (-r "$buildEnvRef->{ACE_ROOT}/ace/config.h") {
    print "ACE_ROOT/ace/config.h exists, skipping configuration of ACE+TAO\n";
  } else {
    # TODO(sonndinh): Create config.h, default.features, platform_macros here.
    # For now, create config.h manually for testing.
  }
  generate_workspace($buildEnvRef);
}

# Attempt to create host and target directories with symlinks to the
# original source tree. But this apparently doesn't work on Windows.
#clone_host_and_target();
#setHostEnv('ACE_ROOT', 'build/host/ACE');
#setHostEnv('TAO_ROOT', 'build/host/TAO');
#write_host_workspace(\%hostEnv);
#configure_build(\%hostEnv);

sub git_clone {
  my $dest = shift;
  my $url = shift;
  my %args = @_;
  my $branch = $args{branch};
  my $commit = $args{commit};

  print "Cloning git repo $url ", $branch // $commit, "\n";

  my $failed;
  if (defined($commit)) {
    # Git can't directly clone a specific commit. Could use clone and checkout,
    # but can't do a single shallow clone that way.
    my $chdir = ChangeDir->new($dest);
    $failed = run_command(['git', 'init', '--quiet']) ||
      run_command(['git', 'remote', 'add', 'origin', $url]) ||
      run_command(['git', 'fetch', '--quiet', '--depth=1', 'origin', $commit]) ||
      run_command(['git', 'checkout', '--quiet', 'FETCH_HEAD']);
  }
  else {
    my @cmd = ('git', 'clone', '--quiet', '--depth=1', $url, $dest);
    push(@cmd, '--branch', $branch) if (defined($branch));
    $failed = run_command(\@cmd);
  }

  if (!$failed) {
    run_command(['git', '--no-pager', 'log', '-1', '--oneline'], chdir => $dest);
  }
  return $failed;
}

sub create_host_tools_clone {
  my $host_dir = shift;
  if (! -d $host_dir) {
    die "ERROR: Failed to create '$host_dir' directory" if (!mkdir($host_dir));
  }

  my $urlbase = 'https://github.com/sonndinh';
  my $branch = 'ghs-integrity-porting';
  my $err = git_clone("$host_dir/ACE_TAO", "$urlbase/ACE_TAO", branch => $branch);
  die "ERROR: Failed to clone ACE/TAO from GitHub, stopped"
    if $err || ! -r "$host_dir/ACE_TAO/ACE/ace/ACE.h" || ! -r "$host_dir/ACE_TAO/TAO/tao/ORB.h";
}

# Instead, create another clone and use it to build host tool.
# The original clone is used to build target.
my $host_tools_dir = "host";

if (! -r "$host_tools_dir/ACE_TAO/ACE/ace/ACE.h") {
  create_host_tools_clone($host_tools_dir);
}

setHostEnv('ACE_ROOT', 'host/ACE_TAO/ACE');
setHostEnv('TAO_ROOT', 'host/ACE_TAO/TAO');

write_host_workspace(\%hostEnv);
configure_build(\%hostEnv);
